# –ú–∏–≥—Ä–∞—Ü–∏—è —Å Natasha –Ω–∞ GPT-based NER –¥–ª—è —Å–∏—Å—Ç–µ–º—ã CEG

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π (CEG) —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–æ–≤. –°—Ç–∞—Ä—ã–π NER –Ω–∞ –±–∞–∑–µ Natasha –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ.

## –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π NER –≤ `entity_recognition.py`

### –ù–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —Å–æ–±—ã—Ç–∏–π:

```python
class ExtractedEntities(BaseModel):
    # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ NER –ø–æ–ª—è
    publication_date: Optional[str]
    people: List[Person]
    companies: List[Company]
    markets: List[Market]
    financial_metrics: List[FinancialMetric]
    
    # üÜï –ù–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è CEG —Å–∏—Å—Ç–µ–º—ã
    sector: Optional[str]                    # –û—Å–Ω–æ–≤–Ω–∞—è –æ—Ç—Ä–∞—Å–ª—å —Å–æ–±—ã—Ç–∏—è
    country: Optional[str]                   # –°—Ç—Ä–∞–Ω–∞ —Å–æ–±—ã—Ç–∏—è
    event_types: List[str]                   # –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π (sanctions, rate_hike, earnings, etc.)
    event: Optional[str]                     # –û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
    
    # üÜï –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤–ª–∏—è–Ω–∏—è
    confidence_score: float = 0.8           # –û–±—â–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å [0, 1]
    language: str = "ru"                    # –Ø–∑—ã–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    
    # üÜï –§–ª–∞–≥–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ CEG
    is_anchor_event: bool = False            # –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ —è–∫–æ—Ä–Ω—ã–º —Å–æ–±—ã—Ç–∏–µ–º
    requires_market_data: bool = False       # –¢—Ä–µ–±—É–µ—Ç –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    urgency_level: str = "normal"           # –°—Ä–æ—á–Ω–æ—Å—Ç—å: low/normal/high/critical
```

### –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –≥–ª–æ—Å—Å–∞—Ä–∏–π —Å–æ–±—ã—Ç–∏–π:

```python
# –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
event_types = {
    "sanctions": ["—Å–∞–Ω–∫—Ü–∏–∏", "–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏", "–∑–∞–ø—Ä–µ—Ç"],
    "rate_hike": ["–∫–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞", "–ø–æ–≤—ã—Å–∏–ª —Å—Ç–∞–≤–∫—É", "—Ü–± –ø–æ–≤—ã—Å–∏–ª"],
    "earnings": ["–ø—Ä–∏–±—ã–ª—å", "–≤—ã—Ä—É—á–∫–∞", "–æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å", "—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã"],
    "m&a": ["—Å–ª–∏—è–Ω–∏–µ", "–ø–æ–≥–ª–æ—â–µ–Ω–∏–µ", "—Å–¥–µ–ª–∫–∞", "–ø—Ä–∏–æ–±—Ä–µ—Ç"],
    "default': ["–¥–µ—Ñ–æ–ª—Ç", "–±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–æ", "–Ω–µ–≤—ã–ø–ª–∞—Ç–∞"],
    "dividends": ["–¥–∏–≤–∏–¥–µ–Ω–¥—ã", "–≤—ã–ø–ª–∞—Ç–∞ –¥–∏–≤–∏–¥–µ–Ω–¥–æ–≤"],
    "ipo": ["ipo", "—Ä–∞–∑–º–µ—â–µ–Ω–∏–µ", "–ø–µ—Ä–≤–∏—á–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ"],
    "regulatory": ["—Ä–µ–≥—É–ª—è—Ç–æ—Ä", "–∑–∞–∫–æ–Ω", "–ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ"],
    "management_change": ["–Ω–æ–≤—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä", "—Å–º–µ–Ω–∞ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞"],
    # ... –∏ –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã
}

# –°–µ–∫—Ç–æ—Ä—ã —ç–∫–æ–Ω–æ–º–∏–∫–∏
sectors = {
    "oil_gas": ["–Ω–µ—Ñ—Ç—å", "–≥–∞–∑", "—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞"],
    "financial": ["–±–∞–Ω–∫", "—Ñ–∏–Ω–∞–Ω—Å—ã", "–∫—Ä–µ–¥–∏—Ç"],
    "technology": ["—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", "IT", "—Ü–∏—Ñ—Ä"],
    # ... –∏ –¥—Ä—É–≥–∏–µ —Å–µ–∫—Ç–æ—Ä—ã
}
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å enrichment_service.py

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:

```python
# –í EnrichmentService.enrich_news()
ai_extracted = await self.ai_ner.extract_entities_async(full_text, verbose=False)

# –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è CEG —Å–∏—Å—Ç–µ–º—ã
enrichment["event_types"] = ai_extracted.event_types
enrichment["ceg_flags"] = {
    "is_anchor_event": ai_extracted.is_anchor_event,
    "requires_market_data": ai_extracted.requires_market_data,
    "urgency_level": ai_extracted.urgency_level,
    "confidence_score": ai_extracted.confidence_score
}
enrichment["sector"] = ai_extracted.sector
enrichment["country"] = ai_extracted.country
```

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º–æ–π

### CompatibilityWrapper –¥–ª—è –ø–æ—ç—Ç–∞–ø–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏:

```python
# –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –∫–æ–¥–æ–º, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–º Natasha
class CompatibilityWrapper:
    def __init__(self, extractor):
        self.extractor = extractor
        
    async def extract_entities(self, text, news_meta=None):
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π NER
        extracted = await self.extractor.extract_entities_async(text)
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç Natasha
        return {
            'matches': [...],  # –°—É—â–Ω–æ—Å—Ç–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Natasha
            'norm': {...},     # –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            'fact': {...},     # –§–∞–∫—Ç—ã
            'meta': {
                **news_meta,
                'event_types': extracted.event_types,
                'is_anchor': extracted.is_anchor_event,
                'urgency': extracted.urgency_level
            }
        }
```

## –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã CEG —Å–∏—Å—Ç–µ–º—ã

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ –Ω–æ–≤–æ—Å—Ç–∏:

1. **–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç** - –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
2. **–í—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏** - –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–≤—è–∑–µ–π –≤ CEG
3. **–ö–æ–º–ø–∞–Ω–∏–∏/—Ç–∏–∫–µ—Ä—ã** - –¥–ª—è –ª–∏–Ω–∫–æ–≤–∫–∏ –∫ —Ä—ã–Ω–∫–∞–º
4. **–¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π** - –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ CEG
5. **–§–ª–∞–≥ —è–∫–æ—Ä–Ω–æ—Å—Ç–∏** - –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏
6. **–£—Ä–æ–≤–µ–Ω—å —Å—Ä–æ—á–Ω–æ—Å—Ç–∏** - –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏

### –î–ª—è EventPredictionEngine:

```python
# –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
if "sanctions" in ai_extracted.event_types:
    predictions.append({
        "type": "follow_up_events",
        "predicted": ["sanctions_compliance", "trade_restrictions"],
        "probability": 0.7,
        "window_days": 7
    })
```

### –î–ª—è ImpactCalculator:

```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –¥–ª—è —Å–æ–±—ã—Ç–∏–π —Å requires_market_data = True
if ai_extracted.requires_market_data:
    impacts = await calculate_impact(
        news_id=str(news.id),
        company_ids=company_tickers,
        published_at=news.published_at
    )
```

### –î–ª—è ImportanceCalculator:

```python
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –≤–∞–∂–Ω–æ—Å—Ç–∏
importance_score = calculate_importance({
    "novelty": ai_extracted.event_types in rare_events,
    "burst": frequency_in_time_window,
    "credibility": source_trust_level,
    "breadth": len(companies),
    "price_impact": market_reaction
})
```

## –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ NER

### –í—Ö–æ–¥–Ω–∞—è –Ω–æ–≤–æ—Å—Ç—å:
```
"–¶–ë –†–§ –ø–æ–≤—ã—Å–∏–ª –∫–ª—é—á–µ–≤—É—é —Å—Ç–∞–≤–∫—É –¥–æ 16%. –ê–∫—Ü–∏–∏ –±–∞–Ω–∫–æ–≤ —É–ø–∞–ª–∏: –°–±–µ—Ä–±–∞–Ω–∫ -5%, –í–¢–ë -8%. 
–ê–Ω–∞–ª–∏—Ç–∏–∫–∏ –æ–∂–∏–¥–∞—é—Ç –∑–∞–º–µ–¥–ª–µ–Ω–∏—è —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ —Ä–æ—Å—Ç–∞."
```

### –í—ã–≤–æ–¥ –Ω–æ–≤–æ–≥–æ NER:
```python
{
    "companies": [
        {"name": "–°–±–µ—Ä–±–∞–Ω–∫", "ticker": "SBER", "sector": "—Ñ–∏–Ω–∞–Ω—Å—ã"},
        {"name": "–í–¢–ë", "ticker": "VTBR", "sector": "—Ñ–∏–Ω–∞–Ω—Å—ã"}
    ],
    "financial_metrics": [
        {"metric_type": "–ø—Ä–æ—Ü–µ–Ω—Ç_–∏–∑–º–µ–Ω–µ–Ω–∏—è", "value": "-5%", "company": "–°–±–µ—Ä–±–∞–Ω–∫"},
        {"metric_type": "–ø—Ä–æ—Ü–µ–Ω—Ç_–∏–∑–º–µ–Ω–µ–Ω–∏—è", "value": "-8%", "company": "–í–¢–ë"}
    ],
    "event_types": ["rate_hike"],
    "sector": "—Ñ–∏–Ω–∞–Ω—Å—ã",
    "country": "–†–æ—Å—Å–∏—è",
    "is_anchor_event": true,           # –Ø–∫–æ—Ä–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ - –≤–ª–∏—è–µ—Ç –Ω–∞ –¥—Ä—É–≥–∏–µ
    "requires_market_data": true,       # –¢—Ä–µ–±—É–µ—Ç –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    "urgency_level": "high",           # –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
    "confidence_score": 0.95
}
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è CEG —Å–∏—Å—Ç–µ–º—ã:

1. **EventExtractor** —Å–æ–∑–¥–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ —Ç–∏–ø–∞ "rate_hike"
2. **EventPredictionEngine** –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Ç–∏–ø–∞
3. **ImpactCalculator** –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –±–∞–Ω–∫–∏
4. **ImportanceCalculator** –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç –≤—ã—Å–æ–∫—É—é –≤–∞–∂–Ω–æ—Å—Ç—å
5. **–ì—Ä–∞—Ñ** —Å–≤—è–∑—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ —Å –±–∞–Ω–∫–∞–º–∏ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è–º–∏

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### Prompt caching:
- –ö—ç—à–∏—Ä—É–µ—Ç—Å—è –≥–ª–æ—Å—Å–∞—Ä–∏–π (~1024 —Ç–æ–∫–µ–Ω–∞)
- –≠–∫–æ–Ω–æ–º–∏—è –¥–æ 90% –Ω–∞ –≤—Ö–æ–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–∞—Ö
- –°—Ç–æ–∏–º–æ—Å—Ç—å: ~$0.003/–Ω–æ–≤–æ—Å—Ç—å

### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:
```python
# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –Ω–æ–≤–æ—Å—Ç–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
results = await extractor.extract_entities_batch_async(news_list)
```

### Fallback —Å–∏—Å—Ç–µ–º–∞:
```python
try:
    entities = await extractor.extract_entities_async(text)
except Exception:
    entities = ExtractedEntities()  # –ü—É—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
```

## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```python
stats = extractor.get_stats_summary()
print(f"Cache hit rate: {stats['cache_hit_rate_percent']}%")
print(f"Token savings: {stats['token_savings_percent']}%")
print(f"Total cost: ${stats['total_cost']:.4f}")
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã CEG

–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:

- **–ò–∑–≤–ª–µ—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–π**: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π
- **–Ø–∫–æ—Ä–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è**: –ø—Ä–æ—Ü–µ–Ω—Ç –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
- **–¢—Ä–µ–±—É—é—â–∏–µ –∞–Ω–∞–ª–∏–∑**: –ø—Ä–æ—Ü–µ–Ω—Ç —Å requires_market_data=true
- **–ü–æ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏**: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ low/normal/high/critical
- **–ü–æ —Å–µ–∫—Ç–æ—Ä–∞–º**: —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏

---

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ CEG —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π!
